<template>
  <SfSidebar
    :visible="isFilterSidebarOpen"
    title="Filters"
    class="sidebar-filters"
    @close="toggleFilterSidebar"
  >
    <div class="filters desktop-only">
      <div v-for="(facet, i) in facets" :key="i">
        <template v-if="isFacetPrice(facet)">
          <SfHeading
            :level="4"
            :title="facet.label"
            class="filters__title sf-heading--left"
          />

          <SfRange
            :value="[20, 600]"
            :disabled="false"
            :config="config"
            v-model="price"
            @change="selectPrice"
          />
        </template>

        <template v-if="facetHasMoreThanOneOption(facet)">
          <SfHeading
            :level="4"
            :title="facet.label"
            class="filters__title sf-heading--left"
            :key="`filter-title-${facet.value}`"
          />
          <div
            v-if="isFacetColor(facet, facet.options)"
            class="filters__colors"
            :key="`${facet.value}-colors`"
          >
            <SfColor
              v-for="option in facet.options"
              :key="`${facet.id}-${option.value}`"
              :data-cy="`category-filter_color_${option.value}`"
              :color="option.htmlColor"
              :selected="isFilterSelected(facet, option)"
              class="filters__color"
              @click="() => selectFilter(facet, option)"
            />
          </div>
          <div v-else>
            <SfFilter
              v-for="option in sortByAscendingProductAttributes(facet.options)"
              :key="`${facet.id}-${option.value}`"
              :data-cy="`category-filter_${facet.id}_${option.value}`"
              :label="
                option.label + `${option.count ? ` (${option.count})` : ''}`
              "
              :selected="isFilterSelected(facet, option)"
              class="filters__item"
              @change="() => selectFilter(facet, option)"
            />
          </div>
        </template>
      </div>
    </div>
    <SfAccordion v-if="productLength > 0" class="filters smartphone-only">
      <SfAccordionItem header="Sort by" class="filters__accordion-item">
          <SfRadio
            v-for="(option, index) in sortBy.options"
            :key="index"
            v-model="sortBy.selected"
            :value="option.value"
            :label="option.attrName"
            class="filters__item"
            @change="changeSortEvent"
          />
        </SfAccordionItem>
      <div v-for="(facet, i) in facets" :key="i">
        <SfAccordionItem
          :key="`filter-title-${facet.id}`"
          :header="facet.label"
          class="filters__accordion-item"
        >
          <template v-if="isFacetPrice(facet)">
            <SfRange
             :value="[20, 600]"
             :disabled="false"
             :config="config"
             v-model="price"
             class="range"
             @change="selectPrice"
           />
          </template>
          <template v-if="facetHasMoreThanOneOption(facet)">
          <div
            v-if="isFacetColor(facet, facet.options)"
            class="filters__colors ml-10"
            :key="`${facet.value}-colors`"
          >
           <SfColor
              v-for="option in facet.options"
              :key="`${facet.id}-${option.value}`"
              :data-cy="`category-filter_color_${option.value}`"
              :color="option.htmlColor"
              :selected="isFilterSelected(facet, option)"
              class="filters__color"
              @click="() => selectFilter(facet, option)"
            />
          </div>
          <div v-else>
            <SfFilter
            v-for="option in sortByAscendingProductAttributes(facet.options)"
            :key="`${facet.id}-${option.id}`"
            :label="option.label"
            :selected="isFilterSelected(facet, option)"
            class="filters__item"
            @change="() => selectFilter(facet, option)"
          />
          </div>
        </template>
        </SfAccordionItem>
      </div>
    </SfAccordion>

    <template #content-bottom>
      <div class="filters__buttons">
        <SfButton class="sf-button--full-width" @click="applyFilters">{{
          $t('Done')
        }}</SfButton>
        <SfButton
          class="sf-button--full-width filters__button-clear"
          @click="clearFilters"
          >{{ $t('Clear all') }}</SfButton
        >
      </div>
    </template>
  </SfSidebar>
</template>
<script>
import {
  SfSidebar,
  SfHeading,
  SfFilter,
  SfSelect,
  SfCheckbox,
  SfLoader,
  SfColor,
  SfButton,
  SfProperty,
  SfImage,
  SfRange,
  SfAccordion
} from '@storefront-ui/vue';
import { facetGetters } from '@vue-storefront/odoo';
import {
  defineComponent,
  ref,
  onMounted,
  reactive,
  computed
} from '@nuxtjs/composition-api';
import { useUiState, useUiHelpers } from '~/composables';

export default defineComponent({
  components: {
    SfSidebar,
    SfHeading,
    SfFilter,
    SfSelect,
    SfCheckbox,
    SfButton,
    SfLoader,
    SfColor,
    SfProperty,
    SfAccordion,
    SfImage,
    SfRange
  },
  props: {
    facetsList: {
      type: Object,
      default: () => []
    },
    productLength: {
      type: Number
    }
  },
  setup(props) {
    const selectedFilters = ref([]);
    const selectedValue = ref();
    const price = ref([]);
    const config = reactive({
      start: [40, 700],
      range: { min: 20, max: 2000 },
      step: 10,
      connect: true,
      direction: 'ltr',
      orientation: 'horizontal',
      behaviour: 'tap-drag',
      tooltips: true,
      keyboardSupport: true
    });

    const { changeFilters, clearAllFilters, isFacetColor, isFacetPrice, facetsFromUrlToFilter } =
      useUiHelpers();
    const { toggleFilterSidebar, isFilterSidebarOpen } = useUiState();

    const clearFilters = () => {
      toggleFilterSidebar();
      selectedFilters.value = [];
      clearAllFilters();
    };

    const applyFilters = () => {
      toggleFilterSidebar();
      changeFilters(selectedFilters.value);
    };

    const isFilterSelected = (facet, option) => {
      return selectedFilters.value.some(
        (filter) => String(filter.id) === String(option.value)
      );
    };

    const changeSortEvent = (sort) => {
      toggleFilterSidebar();
    };

    const facetHasMoreThanOneOption = (facet) =>
      facet?.options?.length > 1 || false;

    const selectPrice = (values) => {
      const newValue = `${values[0]}-${values[1]}`;
      price.value = values;
      const selectedValue = selectedFilters.value.find(
        (item) => item?.filterName === 'price'
      );

      if (selectedValue) {
        selectedValue.id = newValue;
        return;
      }

      selectedFilters.value.push({
        filterName: 'price',
        label: 'Price',
        id: newValue
      });
    };

    const selectFilter = (facet, option) => {
      const alreadySelectedIndex = selectedFilters.value.findIndex(
        (filter) => String(filter.id) === String(option.value)
      );

      if (alreadySelectedIndex === -1) {
        selectedFilters.value.push({
          filterName: facet.label,
          label: option.label,
          id: option.value
        });

        return;
      }

      selectedFilters.value.splice(alreadySelectedIndex, 1);
    };

    const facets = computed(() => [
      {
        id: null,
        label: 'Price',
        type: 'price'
      },
      ...facetGetters.getGrouped(props.facetsList, ['color', 'size'])
    ]);

    const setPrice = () => {
      const selectedValue = selectedFilters.value.find(
        (item) => item?.filterName === 'price'
      );
      
      if (selectedValue) {
        const splitedPriceFromUrl = selectedValue?.id?.split('-');

        price.value = [splitedPriceFromUrl];
        config.start = splitedPriceFromUrl.map((item) => parseInt(item));
      }
    };

    onMounted(() => {
      selectedFilters.value = facetsFromUrlToFilter();
      console.log(selectedFilters.value,'selectedFilters.value')
      setPrice();
    });

    const sortByAscendingProductAttributes = (data) => {
      return data
        ?.sort((a, b) => {
          const labelA = a.label;
          const labelB = b.label;
          if (labelA === labelB) {
            const lastCharA = labelA.charAt(labelA.length - 1);
            const lastCharB = labelB.charAt(labelB.length - 1);
            return lastCharA.localeCompare(lastCharB);
          } else {
            return labelA.localeCompare(labelB);
          }
        })
        ?.sort((a, b) => a.label - b.label);
    };
    return {
      price,
      selectPrice,
      facetHasMoreThanOneOption,
      isFilterSidebarOpen,
      facets,
      config,
      toggleFilterSidebar,
      isFacetColor,
      selectedFilters,
      isFacetPrice,
      changeSortEvent,
      selectFilter,
      isFilterSelected,
      clearFilters,
      applyFilters,
      sortBy,
      sortByAscendingProductAttributes
    };
  }
});
</script>
<style scoped lang="scss">
.sidebar-filters {
  --sidebar-title-display: none;
  --sidebar-top-padding: 0;
  @include for-desktop {
    --sidebar-content-padding: 0 var(--spacer-xl);
    --sidebar-bottom-padding: 0 var(--spacer-xl);
  }
}

.range {
  margin-bottom: 65px;
}

.sf-range {
  width: 80%;
}

.filters {
  &__title {
    --heading-title-font-size: var(--font-size--xl);
    margin: var(--spacer-xl) 0 var(--spacer-base) 0;
    &:first-child {
      margin: calc(var(--spacer-xl) + var(--spacer-base)) 0 var(--spacer-xs) 0;
    }
  }
  &__colors {
    display: flex;
  }
  &__color {
    margin: var(--spacer-xs) var(--spacer-xs) var(--spacer-xs) 0;
  }
  &__chosen {
    color: var(--c-text-muted);
    font-weight: var(--font-weight--normal);
    font-family: var(--font-family--secondary);
    position: absolute;
    right: var(--spacer-xl);
  }
  &__item {
    --radio-container-padding: 0 var(--spacer-sm) 0 var(--spacer-xl);
    --radio-background: transparent;
    --filter-label-color: var(--c-secondary-variant);
    --filter-count-color: var(--c-secondary-variant);
    --checkbox-padding: 0 var(--spacer-sm) 0 var(--spacer-xl);
    padding: var(--spacer-sm) 0;
    border-bottom: 1px solid var(--c-light);
    &:last-child {
      border-bottom: 0;
    }
    @include for-desktop {
      --checkbox-padding: 0;
      margin: var(--spacer-sm) 0;
      border: 0;
      padding: 0;
    }
  }
  &__accordion-item {
    --accordion-item-content-padding: 0;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    width: 100vw;
  }
  &__buttons {
    margin: var(--spacer-sm) 0;
  }
  &__button-clear {
    --button-background: var(--c-light);
    --button-color: var(--c-dark-variant);
    margin: var(--spacer-xs) 0 0 0;
  }
}
</style>
